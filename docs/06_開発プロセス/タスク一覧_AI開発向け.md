# 📋 開発タスク一覧 (AI開発向け) - Timekeeper

このドキュメントは、Timekeeperプロジェクトの開発タスクをAIが理解し実行しやすいように整理したものです。各タスクにはチェックボックスが付いており、進捗管理に使用できます。また、各タスクで参照すべき設計ドキュメントや技術資料へのパスも記載しています。

---

## 1. 共通基盤開発

  - [x] **1.1. 環境構築**
    - [x] 1.1.1. Android (Kotlin + Jetpack Compose) プロジェクト初期設定
      - **参照ドキュメント:** `docs/01_概要・全体像/技術仕様書.md`
      - **テスト:**
        - [x] プロジェクトが正常にビルドできること
        - [x] 空の画面が表示されること
    - [x] 1.1.2. バックエンド (FastAPI) プロジェクト初期設定
      - **参照ドキュメント:** `docs/01_概要・全体像/技術仕様書.md`
      - **テスト:**
        - [x] FastAPIサーバーが起動し、ヘルスチェックAPIが正常にレスポンスを返すこと
    - [x] 1.1.3. Firestore プロジェクトセットアップ
      - **参照ドキュメント:** `docs/01_概要・全体像/技術仕様書.md`, `docs/04_データ設計/データベース.md`
      - **テスト:**
        - [x] バックエンドからFirestoreへの接続が確立できること

  - [x] **1.2. クライアント共通処理**
    - [x] 1.2.1. `device_id` 生成・永続化 (SharedPreferences)
      - **参照ドキュメント:** `docs/01_概要・全体像/技術仕様書.md`
      - **テスト (TC7):**
        - [x] 初回起動時に `device_id` が生成され、SharedPreferencesに保存されること
        - [x] 2回目以降の起動時には保存された `device_id` が使用されること
    - [x] 1.2.2. Room データベース設定 (`apps` テーブルスキーマ定義、DAO作成)
      - **参照ドキュメント:** `docs/04_データ設計/データベース.md`
      - **テスト:**
        - [x] `apps` テーブルのスキーマが正しく定義されていること
        - [x] DAOのCRUD操作が正しく機能すること (単体テスト)
    - [x] 1.2.3. API クライアントモジュール実装 (Retrofit/OkHttp等)
      - **参照ドキュメント:** `docs/03_API仕様/API詳細.md`
      - **テスト:**
        - [x] 各APIエンドポイントへのリクエスト・レスポンスが正しく処理されること (モックサーバーを用いたテスト)
    - [x] 1.2.4. グローバルナビゲーション設定 (Compose Navigation)
      - **参照ドキュメント:** `docs/02_画面設計/画面一覧.md`, `docs/02_画面設計/画面遷移図.md`
      - **テスト:**
        - [x] 定義された画面間の遷移が正しく動作すること
    - [x] 1.2.5. 汎用エラーハンドリング機構 (P06画面への連携含む)
      - **参照ドキュメント:** `docs/05_詳細仕様/エラーハンドリング.md`, `docs/02_画面設計/画面一覧.md` (P06)
      - **テスト:**
        - [x] APIエラー発生時にP06画面へ遷移し、適切なエラーメッセージが表示されること
        - [x] その他の予期せぬエラー発生時にP06画面へ遷移し、適切なエラーメッセージが表示されること

  - [x] **1.3. バックエンド共通処理**
    - [x] 1.3.1. Firestore クライアント初期化・接続設定
      - **参照ドキュメント:** `docs/04_データ設計/データベース.md`
      - **テスト:**
        - [x] Firestoreへの接続が正常に行えること
    - [x] 1.3.2. 共通リクエストバリデーション (`device_id`等)
      - **参照ドキュメント:** `docs/03_API仕様/API詳細.md`, `docs/05_詳細仕様/バリデーション.md`
      - **テスト:**
        - [x] `device_id` が含まれないリクエストに対してエラーが返されること
    - [x] 1.3.3. 共通エラーハンドリングミドルウェア
      - **参照ドキュメント:** `docs/05_詳細仕様/エラーハンドリング.md`
      - **テスト:**
        - [x] 各種エラー発生時に定義されたエラーレスポンスが返されること

---

## 2. 機能実装: ライセンス購入フロー (P01)

  - [ ] **2.1. クライアント (P01: ライセンス購入画面)**
    - [ ] 2.1.1. UI 作成 (テキスト、購入ボタン)
      - **参照ドキュメント:** `docs/02_画面設計/画面一覧.md` (P01)
      - **テスト:**
        - [ ] P01画面のUI要素が正しく表示されること (スナップショットテスト等)
    - [ ] 2.1.2. 状態管理 (`license_purchased` フラグの監視・更新)
      - **参照ドキュメント:** `docs/02_画面設計/状態遷移図.md` (P01関連)
      - **テスト:**
        - [ ] `license_purchased` フラグの状態に応じてUIが正しく更新されること
    - [ ] 2.1.3. Stripe Checkout 連携 (WebView表示、決済セッション開始)
      - **参照ドキュメント:** `docs/01_概要・全体像/技術仕様書.md` (Stripe連携部分), `docs/03_API仕様/Stripe連携フロー.md`
      - **テスト:**
        - [ ] 購入ボタン押下時にStripe CheckoutのWebViewが正しく表示されること
    - [ ] 2.1.4. `/license/confirm` API 呼び出し処理 (成功/失敗ハンドリング)
      - **参照ドキュメント:** `docs/03_API仕様/API詳細.md` (`/license/confirm`), `docs/03_API仕様/Stripe連携フロー.md`
      - **テスト:**
        - [ ] API呼び出し成功時に `license_purchased` フラグが更新されること
        - [ ] API呼び出し失敗時にエラーメッセージが表示されること (P06連携)
    - [ ] 2.1.5. 購入後の画面遷移 (P02へ)
      - **参照ドキュメント:** `docs/02_画面設計/画面遷移図.md`
      - **テスト:**
        - [ ] ライセンス購入成功後、P02画面へ自動遷移すること

  - [ ] **2.2. バックエンド (`/license/confirm` API)**
    - [ ] 2.2.1. リクエストバリデーション (`device_id`, `purchase_token`)
      - **参照ドキュメント:** `docs/03_API仕様/API詳細.md` (`/license/confirm`), `docs/05_詳細仕様/バリデーション.md`, `docs/03_API仕様/Stripe連携フロー.md`
      - **テスト (TC3):**
        - [ ] 未登録 `device_id` でリクエストがあった場合にエラーレスポンスが返却されること
    - [ ] 2.2.2. Stripe API と連携し `purchase_token` を検証
      - **参照ドキュメント:** `docs/01_概要・全体像/技術仕様書.md` (Stripe連携部分), `docs/03_API仕様/Stripe連携フロー.md`
      - **テスト (TC2):**
        - [ ] 不正な `purchase_token` でリクエストがあった場合にエラーレスポンスが返却されること
    - [ ] 2.2.3. Firestore の `devices` コレクションに `device_id` とライセンス購入情報を記録/更新
      - **参照ドキュメント:** `docs/04_データ設計/データベース.md`
      - **テスト (TC1):**
        - [ ] 正常なリクエストでFirestoreの `devices` コレクションにライセンス情報が正しく記録/更新されること
    - [ ] 2.2.4. 成功レスポンス返却
      - **参照ドキュメント:** `docs/03_API仕様/API詳細.md` (`/license/confirm`)
      - **テスト (TC1):**
        - [ ] 正常処理完了時に成功レスポンスが返却されること
    - [ ] 2.2.5. エラーレスポンス返却 (トークン不正、Stripe検証失敗など)
      - **参照ドキュメント:** `docs/03_API仕様/API詳細.md` (`/license/confirm`), `docs/05_詳細仕様/エラーハンドリング.md`
      - **テスト (TC2):**
        - [ ] トークン不正時に適切なエラーレスポンスが返却されること
        - [ ] Stripe検証失敗時に適切なエラーレスポンスが返却されること

---

## 3. 機能実装: 監視対象設定フロー (P02)

  - [ ] **3.1. クライアント (P02: 監視対象設定画面)**
    - [ ] 3.1.1. UI 作成 (アプリ選択リスト、初期時間入力、目標時間入力、追加/更新ボタン)
      - **参照ドキュメント:** `docs/02_画面設計/画面一覧.md` (P02)
      - **テスト:**
        - [ ] P02画面のUI要素が正しく表示されること (スナップショットテスト等)
    - [ ] 3.1.2. アプリ一覧取得ロジック (OSから)
      - **参照ドキュメント:** `docs/01_概要・全体像/技術詳細補足.md` (セクション1: インストール済みアプリ一覧の取得)
      - **テスト:**
        - [ ] インストールされているアプリの一覧が正しく取得できること
    - [ ] 3.1.3. 入力バリデーション (`target_limit_minutes < initial_limit_minutes`)
      - **参照ドキュメント:** `docs/05_詳細仕様/バリデーション.md`
      - **テスト (TC8):**
        - [ ] `target_limit_minutes` が `initial_limit_minutes` より小さい場合にエラーメッセージが表示されること
        - [ ] その他の入力バリデーションが正しく機能すること
    - [ ] 3.1.4. Room への監視対象アプリ情報保存・更新処理
      - **参照ドキュメント:** `docs/04_データ設計/データベース.md`
      - **テスト:**
        - [ ] 入力された監視対象アプリ情報がRoomデータベースに正しく保存・更新されること (DAOテスト)
    - [ ] 3.1.5. 設定完了後の画面遷移 (P03へ)
      - **参照ドキュメント:** `docs/02_画面設計/画面遷移図.md`
      - **テスト:**
        - [ ] 設定完了後、P03画面へ自動遷移すること

---

## 4. 機能実装: ダッシュボード (P03)

  - [ ] **4.1. クライアント (P03: ダッシュボード)**
    - [ ] 4.1.1. UI 作成 (監視中アプリカード一覧、使用時間/残時間バー表示)
      - **参照ドキュメント:** `docs/02_画面設計/画面一覧.md` (P03)
      - **テスト:**
        - [ ] P03画面のUI要素が正しく表示されること (スナップショットテスト等)
    - [ ] 4.1.2. Room から監視対象アプリ情報取得・表示
      - **参照ドキュメント:** `docs/04_データ設計/データベース.md`
      - **テスト:**
        - [ ] Roomから取得した監視対象アプリ情報が画面に正しく表示されること
    - [ ] 4.1.3. 各アプリの使用時間トラッキング (AccessibilityService連携)
      - **参照ドキュメント:** `docs/01_概要・全体像/技術詳細補足.md` (セクション2: AccessibilityService の利用)
      - **テスト:**
        - [ ] AccessibilityServiceが有効な場合、アプリの使用時間が正しくトラッキングされること
    - [ ] 4.1.4. 残時間バーの動的更新 (1分ごと)
      - **参照ドキュメント:** `docs/02_画面設計/画面一覧.md` (P03)
      - **テスト:**
        - [ ] アプリ使用時間の変動に応じて、残時間バーが1分ごとに正しく更新されること
    - [ ] 4.1.5. ロック画面 (P04) への遷移トリガー
      - **参照ドキュメント:** `docs/02_画面設計/画面遷移図.md`
      - **テスト:**
        - [ ] アプリの残時間が0になった場合、P04画面へ遷移すること

---

## 5. 機能実装: アプリロック機能 (P04)

  - [ ] **5.1. クライアント (P04: ロック画面)**
    - [ ] 5.1.1. UI 作成 (メッセージ、アンロックボタン)
      - **参照ドキュメント:** `docs/02_画面設計/画面一覧.md` (P04)
      - **テスト:**
        - [ ] P04画面のUI要素が正しく表示されること (スナップショットテスト等)
    - [ ] 5.1.2. AccessibilityService を利用したアプリ起動検知
      - **参照ドキュメント:** `docs/01_概要・全体像/技術詳細補足.md` (セクション2: AccessibilityService の利用)
      - **テスト:**
        - [ ] 監視対象アプリの起動が正しく検知されること
    - [ ] 5.1.3. 制限時間を超えたアプリのオーバーレイ表示 (SYSTEM_ALERT_WINDOW)
      - **参照ドキュメント:** `docs/01_概要・全体像/技術詳細補足.md` (セクション3: SYSTEM_ALERT_WINDOW (オーバーレイ表示) の利用)
      - **テスト:**
        - [ ] 制限時間を超えたアプリ起動時に、ロック画面がオーバーレイ表示されること
    - [ ] 5.1.4. バックボタン無効化
      - **テスト:**
        - [ ] ロック画面表示中、バックボタンが無効化されていること
    - [ ] 5.1.5. アンロックボタン押下時のデイパス決済画面 (P05) への遷移
      - **参照ドキュメント:** `docs/02_画面設計/画面遷移図.md`
      - **テスト:**
        - [ ] アンロックボタン押下時にP05画面へ遷移すること

---

## 6. 機能実装: デイパス購入フロー (P05)

  - [ ] **6.1. クライアント (P05: デイパス決済画面)**
    - [ ] 6.1.1. UI 作成 (説明文、動的価格表示、アンロックボタン)
      - **参照ドキュメント:** `docs/02_画面設計/画面一覧.md` (P05)
      - **テスト:**
        - [ ] P05画面のUI要素が正しく表示されること (スナップショットテスト等)
    - [ ] 6.1.2. `unlock_count` に基づく価格計算ロジック (`¥(200×1.2^unlock_count)`)
      - **参照ドキュメント:** `docs/01_概要・全体像/機能一覧.md` (デイパス価格計算)
      - **テスト:**
        - [ ] `unlock_count` の値に応じて、デイパスの価格が正しく計算・表示されること
    - [ ] 6.1.3. Stripe Checkout 連携 (WebView表示、決済セッション開始)
      - **参照ドキュメント:** `docs/01_概要・全体像/技術仕様書.md` (Stripe連携部分), `docs/03_API仕様/Stripe連携フロー.md`
      - **テスト:**
        - [ ] アンロックボタン押下時にStripe CheckoutのWebViewが正しく表示されること
    - [ ] 6.1.4. `/unlock/daypass` API 呼び出し処理 (成功/失敗ハンドリング)
      - **参照ドキュメント:** `docs/03_API仕様/API詳細.md` (`/unlock/daypass`), `docs/03_API仕様/Stripe連携フロー.md`
      - **テスト:**
        - [ ] API呼び出し成功時に`unlock_count`, `last_unlock_date` が更新されること
        - [ ] API呼び出し失敗時にエラーメッセージが表示されること (P06連携)
    - [ ] 6.1.5. 決済成功時の状態更新 (`unlock_count`, `last_unlock_date` の SharedPreferences 保存)
      - **参照ドキュメント:** `docs/01_概要・全体像/技術仕様書.md`
      - **テスト:**
        - [ ] 決済成功後、SharedPreferencesの `unlock_count` と `last_unlock_date` が正しく更新されること
    - [ ] 6.1.6. 画面クローズ、ロック解除処理
      - **参照ドキュメント:** `docs/02_画面設計/画面遷移図.md`
      - **テスト:**
        - [ ] 決済成功後、P05画面が閉じられ、アプリのロックが解除されること

  - [ ] **6.2. バックエンド (`/unlock/daypass` API)**
    - [ ] 6.2.1. リクエストバリデーション (`device_id`, `purchase_token`)
      - **参照ドキュメント:** `docs/03_API仕様/API詳細.md` (`/unlock/daypass`), `docs/05_詳細仕様/バリデーション.md`, `docs/03_API仕様/Stripe連携フロー.md`
      - **テスト (TC6):**
        - [ ] 未登録 `device_id` でリクエストがあった場合にエラーレスポンスが返却されること
    - [ ] 6.2.2. Stripe API と連携し `purchase_token` を検証
      - **参照ドキュメント:** `docs/01_概要・全体像/技術仕様書.md` (Stripe連携部分), `docs/03_API仕様/Stripe連携フロー.md`
      - **テスト (TC5):**
        - [ ] 不正な `purchase_token` でリクエストがあった場合にエラーレスポンスが返却されること
    - [ ] 6.2.3. Firestore の `devices` コレクションで `unlock_count` をインクリメント、`last_unlock_date` を更新
      - **参照ドキュメント:** `docs/04_データ設計/データベース.md`
      - **テスト (TC4):**
        - [ ] 正常なリクエストでFirestoreの `devices` コレクションの `unlock_count` と `last_unlock_date` が正しく更新されること
    - [ ] 6.2.4. 成功レスポンス返却 (`status`, `unlock_count`, `last_unlock_date`)
      - **参照ドキュメント:** `docs/03_API仕様/API詳細.md` (`/unlock/daypass`)
      - **テスト (TC4):**
        - [ ] 正常処理完了時に成功レスポンス (`status`, `unlock_count`, `last_unlock_date`) が返却されること
    - [ ] 6.2.5. エラーレスポンス返却 (トークン不正、Stripe検証失敗など)
      - **参照ドキュメント:** `docs/03_API仕様/API詳細.md` (`/unlock/daypass`), `docs/05_詳細仕様/エラーハンドリング.md`
      - **テスト (TC5):**
        - [ ] トークン不正時に適切なエラーレスポンスが返却されること
        - [ ] Stripe検証失敗時に適切なエラーレスポンスが返却されること

---

## 7. 機能実装: エラー/ブロック案内 (P06)

  - [ ] **7.1. クライアント (P06: エラー案内画面)**
    - [ ] 7.1.1. UI 作成 (メッセージ、ボタン)
      - **参照ドキュメント:** `docs/02_画面設計/画面一覧.md` (P06)
      - **テスト:**
        - [ ] P06画面のUI要素がエラーケースに応じて正しく表示されること (スナップショットテスト等)
    - [ ] 7.1.2. 表示パターンの実装:
      - [ ] ライセンス未購入時のアクセス → 「ライセンス購入が必要です」＋「購入画面へ」ボタン (P01へ遷移)
        - **参照ドキュメント:** `docs/05_詳細仕様/エラーハンドリング.md`
        - **テスト:**
          - [ ] ライセンス未購入で特定の機能にアクセスしようとした場合、該当のメッセージとボタンが表示され、P01へ遷移すること
      - [ ] JSONパースエラー/予期せぬAPIエラー → 「予期しないエラーが発生しました」＋「再試行」ボタン
        - **参照ドキュメント:** `docs/05_詳細仕様/エラーハンドリング.md`
        - **テスト:**
          - [ ] APIレスポンスが不正なJSONの場合、または予期せぬAPIエラーが発生した場合、該当のメッセージとボタンが表示されること
      - [ ] デイパスのStripe決済成功 → Firestore更新失敗時 → 「課金は成功しましたが、ロック解除に失敗しました」＋「問い合わせる」ボタン
        - **参照ドキュメント:** `docs/05_詳細仕様/エラーハンドリング.md`
        - **テスト (TC9):**
          - [ ] デイパス購入のStripe決済は成功したが、バックエンドでのFirestore更新に失敗した場合、該当のメッセージとボタンが表示されること

---

## 8. テスト (上記タスクに含まれないもの)

  - [ ] **8.1. APIテスト (バックエンド)** (タスク内で言及済みのものは省略)
    - (特になし。各API実装タスク内でテストを記載)

  - [ ] **8.2. クライアント単体テスト・UIテスト** (タスク内で言及済みのものは省略)
    - [ ] 各画面のUI表示確認 (スナップショットテスト等) - 各画面実装タスクで実施
    - [ ] 各画面のバリデーションロジックテスト - 各画面実装タスクで実施
    - [ ] RoomデータベースのCRUD操作テスト - 共通基盤開発タスクで実施

  - [ ] **8.3. 結合テスト**
    - [ ] 8.3.1. ライセンス購入フロー全体のテスト (P01 → API → Firestore)
      - **テストシナリオ:**
        1. P01画面からライセンス購入を実行
        2. `/license/confirm` APIが呼び出され、Stripe検証成功
        3. Firestoreにライセンス情報が記録される
        4. P02画面へ遷移する
    - [ ] 8.3.2. デイパス購入フロー全体のテスト (P05 → API → Firestore)
      - **テストシナリオ:**
        1. P05画面からデイパス購入を実行
        2. `/unlock/daypass` APIが呼び出され、Stripe検証成功
        3. Firestoreの `unlock_count`, `last_unlock_date` が更新される
        4. P05画面が閉じられ、ロックが解除される
    - [ ] 8.3.3. アプリロック → デイパス購入 → ロック解除のシーケンステスト
      - **テストシナリオ:**
        1. 監視対象アプリの残時間が0になり、P04ロック画面が表示される
        2. P04画面からアンロックボタンを押し、P05デイパス購入画面へ遷移
        3. P05画面でデイパスを購入
        4. アプリのロックが解除され、再度アプリが使用可能になる

---

## 9. リリース準備

  - [ ] 9.1. Android アプリの ProGuard/R8 設定 (難読化・最適化)
    - **参照ドキュメント:** `docs/01_概要・全体像/技術仕様書.md` (ProGuard/R8設定の方針)、(必要であればAndroid開発者ドキュメント等)
  - [ ] 9.2. Android APK / App Bundle ビルド
    - **参照ドキュメント:** `docs/01_概要・全体像/技術仕様書.md` (ビルド成果物について)、(必要であればAndroid開発者ドキュメント等)
  - [ ] 9.3. バックエンド API のデプロイ準備 (Cloud Run設定、Dockerfile作成)
    - **参照ドキュメント:** `docs/01_概要・全体像/技術仕様書.md` (デプロイ環境について)、(必要であればCloud Run/Docker ドキュメント等)
  - [ ] 9.4. README.md の作成 (ビルド方法、デプロイ方法など)
    - **テスト:**
        - [ ] README.mdの記述に従ってビルド・デプロイが可能であること

</rewritten_file> 